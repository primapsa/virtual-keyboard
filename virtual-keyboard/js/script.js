const CONFIG = [
  [
    {
      Backquote: {
        en: { lower: '`', upper: '~' },
        ru: { lower: 'ё', upper: 'Ё' },
      },
    },
    {
      Digit1: {
        en: { lower: '1', upper: '!' },
        ru: { lower: '1', upper: '!' },
      },
    },
    {
      Digit2: {
        en: { lower: '2', upper: '@' },
        ru: { lower: '2', upper: '"' },
      },
    },
    {
      Digit3: {
        en: { lower: '3', upper: '#' },
        ru: { lower: '3', upper: '№' },
      },
    },
    {
      Digit4: {
        en: { lower: '4', upper: '$' },
        ru: { lower: '4', upper: ';' },
      },
    },
    {
      Digit5: {
        en: { lower: '5', upper: '%' },
        ru: { lower: '5', upper: '%' },
      },
    },
    {
      Digit6: {
        en: { lower: '6', upper: '^' },
        ru: { lower: '6', upper: ':' },
      },
    },
    {
      Digit7: {
        en: { lower: '7', upper: '&' },
        ru: { lower: '7', upper: '?' },
      },
    },
    {
      Digit8: {
        en: { lower: '8', upper: '*' },
        ru: { lower: '8', upper: '*' },
      },
    },
    {
      Digit9: {
        en: { lower: '9', upper: '(' },
        ru: { lower: '9', upper: '(' },
      },
    },
    {
      Digit0: {
        en: { lower: '0', upper: ')' },
        ru: { lower: '0', upper: ')' },
      },
    },
    {
      Minus: {
        en: { lower: '-', upper: '_' },
        ru: { lower: '-', upper: '_' },
      },
    },
    {
      Equal: {
        en: { lower: '=', upper: '+' },
        ru: { lower: '=', upper: '+' },
      },
    },
    {
      Backspace: {
        en: { lower: 'Backspace', upper: 'Backspace' },
        ru: { lower: 'Backspace', upper: 'Backspace' },
      },
    },
  ],
  [
    {
      Tab: {
        en: { lower: 'Tab', upper: 'Tab' },
        ru: { lower: 'Tab', upper: 'Tab' },
      },
    },
    {
      KeyQ: {
        en: { lower: 'q', upper: 'Q' },
        ru: { lower: 'й', upper: 'Й' },
      },
    },
    {
      KeyW: {
        en: { lower: 'w', upper: 'W' },
        ru: { lower: 'ц', upper: 'Ц' },
      },
    },
    {
      KeyE: {
        en: { lower: 'e', upper: 'E' },
        ru: { lower: 'у', upper: 'У' },
      },
    },
    {
      KeyR: {
        en: { lower: 'r', upper: 'R' },
        ru: { lower: 'к', upper: 'К' },
      },
    },
    {
      KeyT: {
        en: { lower: 't', upper: 'T' },
        ru: { lower: 'е', upper: 'Е' },
      },
    },
    {
      KeyY: {
        en: { lower: 'y', upper: 'Y' },
        ru: { lower: 'н', upper: 'Н' },
      },
    },
    {
      KeyU: {
        en: { lower: 'u', upper: 'U' },
        ru: { lower: 'г', upper: 'Г' },
      },
    },
    {
      KeyI: {
        en: { lower: 'i', upper: 'I' },
        ru: { lower: 'ш', upper: 'Ш' },
      },
    },
    {
      KeyO: {
        en: { lower: 'o', upper: 'O' },
        ru: { lower: 'щ', upper: 'Щ' },
      },
    },
    {
      KeyP: {
        en: { lower: 'p', upper: 'P' },
        ru: { lower: 'з', upper: 'З' },
      },
    },
    {
      BracketLeft: {
        en: { lower: '[', upper: '{' },
        ru: { lower: 'х', upper: 'Х' },
      },
    },
    {
      BracketRight: {
        en: { lower: ']', upper: '}' },
        ru: { lower: 'ъ', upper: 'Ъ' },
      },
    },
    {
      Backslash: {
        en: { lower: '\\', upper: '/' },
        ru: { lower: '\\', upper: '/' },
      },
    },
    {
      Delete: {
        en: { lower: 'Del', upper: 'Del' },
        ru: { lower: 'Del', upper: 'Del' },
      },
    },
  ],
  [
    {
      CapsLock: {
        en: { lower: 'CapsLock', upper: 'CapsLock' },
        ru: { lower: 'CapsLock', upper: 'CapsLock' },
      },
    },
    {
      KeyA: {
        en: { lower: 'a', upper: 'A' },
        ru: { lower: 'ф', upper: 'Ф' },
      },
    },
    {
      KeyS: {
        en: { lower: 's', upper: 'S' },
        ru: { lower: 'ы', upper: 'Ы' },
      },
    },
    {
      KeyD: {
        en: { lower: 'd', upper: 'D' },
        ru: { lower: 'в', upper: 'В' },
      },
    },
    {
      KeyF: {
        en: { lower: 'f', upper: 'F' },
        ru: { lower: 'а', upper: 'А' },
      },
    },
    {
      KeyG: {
        en: { lower: 'g', upper: 'G' },
        ru: { lower: 'п', upper: 'П' },
      },
    },
    {
      KeyH: {
        en: { lower: 'h', upper: 'H' },
        ru: { lower: 'р', upper: 'Р' },
      },
    },
    {
      KeyJ: {
        en: { lower: 'j', upper: 'J' },
        ru: { lower: 'о', upper: 'О' },
      },
    },
    {
      KeyK: {
        en: { lower: 'k', upper: 'K' },
        ru: { lower: 'л', upper: 'Л' },
      },
    },
    {
      KeyL: {
        en: { lower: 'l', upper: 'L' },
        ru: { lower: 'д', upper: 'Д' },
      },
    },
    {
      Semicolon: {
        en: { lower: ';', upper: ':' },
        ru: { lower: 'ж', upper: 'Ж' },
      },
    },
    {
      Quote: {
        en: { lower: "'", upper: '"' },
        ru: { lower: 'э', upper: 'Э' },
      },
    },
    {
      Enter: {
        en: { lower: 'Enter', upper: 'Enter' },
        ru: { lower: 'Enter', upper: 'Enter' },
      },
    },
  ],
  [
    {
      ShiftLeft: {
        en: { lower: 'Shift', upper: 'Shift' },
        ru: { lower: 'Shift', upper: 'Shift' },
      },
    },
    {
      KeyZ: {
        en: { lower: 'z', upper: 'Z' },
        ru: { lower: 'я', upper: 'Я' },
      },
    },
    {
      KeyX: {
        en: { lower: 'x', upper: 'X' },
        ru: { lower: 'ч', upper: 'Ч' },
      },
    },
    {
      KeyC: {
        en: { lower: 'c', upper: 'C' },
        ru: { lower: 'с', upper: 'С' },
      },
    },
    {
      KeyV: {
        en: { lower: 'v', upper: 'V' },
        ru: { lower: 'м', upper: 'М' },
      },
    },
    {
      KeyB: {
        en: { lower: 'b', upper: 'B' },
        ru: { lower: 'и', upper: 'И' },
      },
    },
    {
      KeyN: {
        en: { lower: 'n', upper: 'N' },
        ru: { lower: 'т', upper: 'Т' },
      },
    },
    {
      KeyM: {
        en: { lower: 'm', upper: 'M' },
        ru: { lower: 'ь', upper: 'Ь' },
      },
    },
    {
      Comma: {
        en: { lower: ',', upper: '<' },
        ru: { lower: 'б', upper: 'Б' },
      },
    },
    {
      Period: {
        en: { lower: '.', upper: '>' },
        ru: { lower: 'ю', upper: 'Ю' },
      },
    },
    {
      Slash: {
        en: { lower: '/', upper: '?' },
        ru: { lower: '.', upper: ',' },
      },
    },
    {
      ArrowUp: {
        en: { lower: '&#9650;', upper: '&#9650;' },
        ru: { lower: '&#9650;', upper: '&#9650;' },
      },
    },
    {
      ShiftRight: {
        en: { lower: 'Shift', upper: 'Shift' },
        ru: { lower: 'Shift', upper: 'Shift' },
      },
    },
  ],
  [
    {
      ControlLeft: {
        en: { lower: 'ctrl', upper: 'ctrl' },
        ru: { lower: 'ctrl', upper: 'ctrl' },
      },
    },

    {
      MetaLeft: {
        en: { lower: 'Win', upper: 'Win' },
        ru: { lower: 'Win', upper: 'Win' },
      },
    },
    {
      AltLeft: {
        en: { lower: 'alt', upper: 'alt' },
        ru: { lower: 'alt', upper: 'alt' },
      },
    },
    {
      Space: {
        en: { lower: ' ', upper: ' ' },
        ru: { lower: ' ', upper: ' ' },
      },
    },
    {
      AltRight: {
        en: { lower: 'alt', upper: 'alt' },
        ru: { lower: 'alt', upper: 'alt' },
      },
    },
    {
      ArrowLeft: {
        en: { lower: '&#9668;', upper: '&#9668;' },
        ru: { lower: '&#9668;', upper: '&#9668;' },
      },
    },
    {
      ArrowDown: {
        en: { lower: '&#9660;', upper: '&#9660;' },
        ru: { lower: '&#9660;', upper: '&#9660;' },
      },
    },
    {
      ArrowRight: {
        en: { lower: '&#9658;', upper: '&#9658;' },
        ru: { lower: '&#9658;', upper: '&#9658;' },
      },
    },
    {
      ControlRight: {
        en: { lower: 'ctrl', upper: 'ctrl' },
        ru: { lower: 'ctrl', upper: 'ctrl' },
      },
    },
  ],
];

const CONTROLS = ['Tab', 'CapsLock', 'ShiftLeft', 'ShiftRight', 'ControlLeft', 'MetaLeft', 'AltLeft', 'Space', 'AltRight', 'ControlRight', 'Backspace', 'Enter', 'Delete'];
class Keyboard {
  constructor(content, controls) {
    this.current = null;
    this.language = localStorage.getItem('lang') || 'en';
    this.domConfig = content;
    this.isShift = false;
    this.isCapsLock = false;
    this.isAlt = false;
    this.isControl = false;   
    this.controls = controls;
    this.printKeyValue = this.printKeyValue.bind(this);
    this.keyCase = 'lower';
  }

  initialDom() {
    let keysLine = '';
    localStorage.setItem('lang', this.language);
    this.domConfig.forEach((line) => {
      let content = '';
      line.forEach((node) => {
        const keyName = Object.keys(node)[0];
        const keyLangs = Object.keys(node[keyName]);
        let keyInner = '';
        keyLangs.forEach((k) => {
          const initialLanguage = this.getLanguage();
          if (initialLanguage === k) {
            keyInner += `<div class="${k} active lower">${node[keyName][k].lower}</div>`;
          } else {
            keyInner += `<div class="${k} lower">${node[keyName][k].lower}</div>`;
          }
          keyInner += `<div class="${k} upper">${node[keyName][k].upper}</div>`;
        });
        content += `<div class="key ${keyName} alphabet">${keyInner}</div>`;
      });
      keysLine += `<div class="keyboard-line">${content}</div>`;
    });
    keysLine = `<div class="wrapper"><div class="container"><div class="keyboard"><div class="keyboard__display"><textarea class="keyboard__textarea"></textarea></div><div class="keyboard__board">${keysLine}</div></div></div></div>`;
    // return keysLine;
    document.body.insertAdjacentHTML('afterbegin', keysLine);
  }

  getLanguage() {
    return localStorage.getItem('lang') || 'en';
  }

  toggleLanguage() {
    let language = localStorage.getItem('lang');
    language = language === 'en' ? 'ru' : 'en';
    localStorage.setItem('lang', language);
  }

  keyDown(e) {
    let { keyCode } = e;
    keyCode = Number(keyCode);
    if (!(keyCode >= 8 && keyCode <= 220)) return;
    e.preventDefault();
    const keyPressed = document.querySelector(`.${e.code}`);

    if (!keyPressed) return;
    const keyName = keyPressed.classList[1];

    if ((keyName === 'ShiftLeft' || keyName === 'ShiftRight') && this.isShift) return;
    if ((keyName === 'ShiftLeft' || keyName === 'ShiftRight') && !this.isShift) this.isShift = true;
    if ((keyName === 'AltLeft' || keyName === 'AltRight') && this.isAlt) return;
    if ((keyName === 'AltLeft' || keyName === 'AltRight') && !this.isAlt) this.isAlt = true;
    if ((keyName === 'ControlLeft' || keyName === 'ControlRight') && this.isControl) return;
    if ((keyName === 'ControlLeft' || keyName === 'ControlRight') && !this.isControl) this.isControl = true;
    if ((keyName === 'CapsLock') && this.isCapsLock) return;
   

    if (this.isControl && this.isAlt) {
      this.toggleKeyLanguage();
    }

    if (keyName === 'ShiftLeft' || keyName === 'ShiftRight') {
      
      this.toggleKeyCase();
    }

    if (keyName === 'CapsLock') {
      this.isCapsLock = true;
      keyPressed.classList.toggle('on');
      this.toggleKeyCase();
    }
    this.printKeyValue(keyPressed);
    keyPressed.classList.add('pressed');
  }

  keyUp(e) {
    let { keyCode } = e;
    keyCode = Number(keyCode);
    if (!(keyCode >= 8 && keyCode <= 220)) return;
    e.preventDefault();
    const keyPressed = document.querySelector(`.${e.code}`);

    if (!keyPressed) return;
    const keyName = keyPressed.classList[1];

    if ((keyName === 'ShiftLeft' || keyName === 'ShiftRight')) {
      this.isShift = false;
      this.toggleKeyCase();
    }
    if ((keyName === 'AltLeft' || keyName === 'AltRight')) {
      this.isAlt = false;
    }
    if ((keyName === 'ControlLeft' || keyName === 'ControlRight')) {
      this.isControl = false;
    }
    if (keyName === 'CapsLock') {
      this.isCapsLock = false;      
     
    }
    keyPressed.classList.remove('pressed');
  }

  renderKeyboard() {
    this.initialDom();
    const body = document.querySelector('body');
    document.addEventListener('keydown', this.keyDown.bind(this));
    document.addEventListener('keyup', this.keyUp.bind(this));
  }

  printKeyValue(node) {
   
    const textarea = document.querySelector('.keyboard__textarea');
    const keyName = node.classList[1];
    let keyValue = '';
    if (this.controls.includes(keyName)) {
      // controls; dont print in textarea
      if (keyName === 'Space') {
        keyValue = ' ';
      }
      if (keyName === 'Tab') {
        keyValue = '    ';
      }
      if (keyName === 'Enter') {
        keyValue = '\n';
      }
    } else {
      keyValue = Array.from(node.children).filter((el) => el.classList.contains('active'))[0].innerText;
    }
    textarea.value += keyValue;
  }

  toggleKeyCase() {
    // if (!this.isShift) return;
    const activeKeys = document.querySelectorAll('.key');
    activeKeys.forEach((key) => {
      Array.from(key.children).forEach((child) => {
        if (child.classList.contains(this.getLanguage())) { child.classList.toggle('active'); }
      });
    });
  }

  toggleKeyLanguage() {
    const activeKeys = document.querySelectorAll('.key');
    activeKeys.forEach((key) => {
      let toggleNode = null;
      Array.from(key.children).forEach((child) => {
        // console.log(child.classList.contains(this.keyCase))
        if (child.classList.contains(this.keyCase)
        && !child.classList.contains(this.getLanguage())) {
          toggleNode = child;
          // console.log(this.keyCase)
        }
        child.classList.remove('active');
      });
      toggleNode.classList.add('active');
    });
    this.toggleLanguage();
  }

  toggleCase() {
    this.keyCase = this.keyCase === 'lower' ? 'upper' : 'lower';
  }

  setShift() {
    this.isShift = !this.isShift;
  }

  getShift() {
    return this.isShift;
  }

  
}
const keyboard = new Keyboard(CONFIG, CONTROLS);
keyboard.renderKeyboard();


// const domContent = keyboard.initialDom(config);
// const body = document.querySelector('body');
// body.insertAdjacentHTML('afterbegin', domContent);

// const DOUBLE_CONTROLS = [16,17,18];

// let body = document.querySelector("body");
// generateContent();

// let keyboard = document.querySelector(".keyboard__board");

// document.addEventListener('keydown', keyPressDown);
// document.addEventListener('keyup', keyPressUp);
// keyboard.addEventListener('mousedown', mouseKeyDown);
// keyboard.addEventListener('mouseup', mouseKeyUp);
// function backlightKey(node){

// }

// function mouseKeyDown(e){
//     let target = e.target.closest(".key");
//     if(!target) return;
//     target.classList.add('pressed');
//     printText(target);
// }
// function mouseKeyUp(e){
//     let target = e.target.closest(".key");
//     if(!target) return;
//     target.classList.remove('pressed');

// }
// function printText(node) {
//     let textarea = document.querySelector('.keyboard__textarea');
//     let isShiftPresed = getShiftStatus();
//     let nodeValue = node.innerText;
//     if(node.classList.contains("key-code-32")){
//         nodeValue = " ";

//     }
//     if(node.classList.contains("tab")){
//         nodeValue = "    ";

//     }
//     if(node.classList.contains("alphabet") ||
// node.classList.contains("space") || node.classList.contains("tab")){
//        textarea.value += nodeValue;
//     }

// }
// function getShiftStatus(){

// }
// function keyPressDown(e){
//     let keyCode = e.keyCode;
//     let keyCodeAdditional = '';
//     keyCode = Number(keyCode);
//     if(!(keyCode >= 8 && keyCode <= 220)) return;
//     e.preventDefault();
//     if(DOUBLE_CONTROLS.includes(keyCode)){
//         keyCodeAdditional = '.'+e.code.toLowerCase();
//         console.log(`.key-code-${keyCode}${keyCodeAdditional}`)
//     }
//     let keyPressed = body.querySelector(`.key-code-${keyCode}${keyCodeAdditional}`);

//     if(keyPressed) {
//         printText(keyPressed);
//         keyPressed.classList.add('pressed');
//     }
// }
// function keyPressUp(e){
//     let keyCode = e.keyCode;
//     let keyCodeAdditional = '';
//     keyCode = Number(keyCode);
//     if(!(keyCode >= 8 && keyCode <= 220)) return;
//     if(DOUBLE_CONTROLS.includes(keyCode)){
//         keyCodeAdditional = '.'+e.code.toLowerCase();
//         console.log(`.key-code-${keyCode}${keyCodeAdditional}`)
//     }
//     let keyPressed = body.querySelector(`.key-code-${keyCode}${keyCodeAdditional}`);
//     if(keyPressed)
//     if(keyPressed) keyPressed.classList.remove('pressed');
// }

// function generateContent() {
//   body.insertAdjacentHTML("afterbegin", innerBody);

//   let currentLanguage = getCurrentLanguage();
//   if (currentLanguage == "en") {

//   }
//   initialLanguage(LANG_ENG);
// }
// function getCurrentLanguage() {
//   //local storage
//   return "en";
// }
// function initialLanguage(obj) {
//   let keys = document.querySelectorAll(".alphabet");
//   keys.forEach((key) => {
//     let keycode = key.classList[1];
//     keycode = keycode.split('-')[2];
//     let value = obj[keycode];

//     if( key.classList.contains('functional')){
//        if(key.lastElementChild) key.lastElementChild.innerHTML =  value?.main || '';
//        if(key.firstElementChild)key.firstElementChild.innerHTML = value?.extra || '';
//     }else{
//     key.innerHTML = value || 'null';  }
//   });
// }
