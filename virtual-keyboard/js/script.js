const CONFIG = [
  [
    {
      Backquote: {
        en: { lower: '`', upper: '~' },
        ru: { lower: 'ё', upper: 'Ё' },
      },
    },
    {
      Digit1: {
        en: { lower: '1', upper: '!' },
        ru: { lower: '1', upper: '!' },
      },
    },
    {
      Digit2: {
        en: { lower: '2', upper: '@' },
        ru: { lower: '2', upper: '"' },
      },
    },
    {
      Digit3: {
        en: { lower: '3', upper: '#' },
        ru: { lower: '3', upper: '№' },
      },
    },
    {
      Digit4: {
        en: { lower: '4', upper: '$' },
        ru: { lower: '4', upper: ';' },
      },
    },
    {
      Digit5: {
        en: { lower: '5', upper: '%' },
        ru: { lower: '5', upper: '%' },
      },
    },
    {
      Digit6: {
        en: { lower: '6', upper: '^' },
        ru: { lower: '6', upper: ':' },
      },
    },
    {
      Digit7: {
        en: { lower: '7', upper: '&' },
        ru: { lower: '7', upper: '?' },
      },
    },
    {
      Digit8: {
        en: { lower: '8', upper: '*' },
        ru: { lower: '8', upper: '*' },
      },
    },
    {
      Digit9: {
        en: { lower: '9', upper: '(' },
        ru: { lower: '9', upper: '(' },
      },
    },
    {
      Digit0: {
        en: { lower: '0', upper: ')' },
        ru: { lower: '0', upper: ')' },
      },
    },
    {
      Minus: {
        en: { lower: '-', upper: '_' },
        ru: { lower: '-', upper: '_' },
      },
    },
    {
      Equal: {
        en: { lower: '=', upper: '+' },
        ru: { lower: '=', upper: '+' },
      },
    },
    {
      Backspace: {
        en: { lower: 'Backspace', upper: 'Backspace' },
        ru: { lower: 'Backspace', upper: 'Backspace' },
      },
    },
  ],
  [
    {
      Tab: {
        en: { lower: 'Tab', upper: 'Tab' },
        ru: { lower: 'Tab', upper: 'Tab' },
      },
    },
    {
      KeyQ: {
        en: { lower: 'q', upper: 'Q' },
        ru: { lower: 'й', upper: 'Й' },
      },
    },
    {
      KeyW: {
        en: { lower: 'w', upper: 'W' },
        ru: { lower: 'ц', upper: 'Ц' },
      },
    },
    {
      KeyE: {
        en: { lower: 'e', upper: 'E' },
        ru: { lower: 'у', upper: 'У' },
      },
    },
    {
      KeyR: {
        en: { lower: 'r', upper: 'R' },
        ru: { lower: 'к', upper: 'К' },
      },
    },
    {
      KeyT: {
        en: { lower: 't', upper: 'T' },
        ru: { lower: 'е', upper: 'Е' },
      },
    },
    {
      KeyY: {
        en: { lower: 'y', upper: 'Y' },
        ru: { lower: 'н', upper: 'Н' },
      },
    },
    {
      KeyU: {
        en: { lower: 'u', upper: 'U' },
        ru: { lower: 'г', upper: 'Г' },
      },
    },
    {
      KeyI: {
        en: { lower: 'i', upper: 'I' },
        ru: { lower: 'ш', upper: 'Ш' },
      },
    },
    {
      KeyO: {
        en: { lower: 'o', upper: 'O' },
        ru: { lower: 'щ', upper: 'Щ' },
      },
    },
    {
      KeyP: {
        en: { lower: 'p', upper: 'P' },
        ru: { lower: 'з', upper: 'З' },
      },
    },
    {
      BracketLeft: {
        en: { lower: '[', upper: '{' },
        ru: { lower: 'х', upper: 'Х' },
      },
    },
    {
      BracketRight: {
        en: { lower: ']', upper: '}' },
        ru: { lower: 'ъ', upper: 'Ъ' },
      },
    },
    {
      Backslash: {
        en: { lower: '\\', upper: '/' },
        ru: { lower: '\\', upper: '/' },
      },
    },
    {
      Delete: {
        en: { lower: 'Del', upper: 'Del' },
        ru: { lower: 'Del', upper: 'Del' },
      },
    },
  ],
  [
    {
      CapsLock: {
        en: { lower: 'CapsLock', upper: 'CapsLock' },
        ru: { lower: 'CapsLock', upper: 'CapsLock' },
      },
    },
    {
      KeyA: {
        en: { lower: 'a', upper: 'A' },
        ru: { lower: 'ф', upper: 'Ф' },
      },
    },
    {
      KeyS: {
        en: { lower: 's', upper: 'S' },
        ru: { lower: 'ы', upper: 'Ы' },
      },
    },
    {
      KeyD: {
        en: { lower: 'd', upper: 'D' },
        ru: { lower: 'в', upper: 'В' },
      },
    },
    {
      KeyF: {
        en: { lower: 'f', upper: 'F' },
        ru: { lower: 'а', upper: 'А' },
      },
    },
    {
      KeyG: {
        en: { lower: 'g', upper: 'G' },
        ru: { lower: 'п', upper: 'П' },
      },
    },
    {
      KeyH: {
        en: { lower: 'h', upper: 'H' },
        ru: { lower: 'р', upper: 'Р' },
      },
    },
    {
      KeyJ: {
        en: { lower: 'j', upper: 'J' },
        ru: { lower: 'о', upper: 'О' },
      },
    },
    {
      KeyK: {
        en: { lower: 'k', upper: 'K' },
        ru: { lower: 'л', upper: 'Л' },
      },
    },
    {
      KeyL: {
        en: { lower: 'l', upper: 'L' },
        ru: { lower: 'д', upper: 'Д' },
      },
    },
    {
      Semicolon: {
        en: { lower: ';', upper: ':' },
        ru: { lower: 'ж', upper: 'Ж' },
      },
    },
    {
      Quote: {
        en: { lower: "'", upper: '"' },
        ru: { lower: 'э', upper: 'Э' },
      },
    },
    {
      Enter: {
        en: { lower: 'Enter', upper: 'Enter' },
        ru: { lower: 'Enter', upper: 'Enter' },
      },
    },
  ],
  [
    {
      ShiftLeft: {
        en: { lower: 'Shift', upper: 'Shift' },
        ru: { lower: 'Shift', upper: 'Shift' },
      },
    },
    {
      KeyZ: {
        en: { lower: 'z', upper: 'Z' },
        ru: { lower: 'я', upper: 'Я' },
      },
    },
    {
      KeyX: {
        en: { lower: 'x', upper: 'X' },
        ru: { lower: 'ч', upper: 'Ч' },
      },
    },
    {
      KeyC: {
        en: { lower: 'c', upper: 'C' },
        ru: { lower: 'с', upper: 'С' },
      },
    },
    {
      KeyV: {
        en: { lower: 'v', upper: 'V' },
        ru: { lower: 'м', upper: 'М' },
      },
    },
    {
      KeyB: {
        en: { lower: 'b', upper: 'B' },
        ru: { lower: 'и', upper: 'И' },
      },
    },
    {
      KeyN: {
        en: { lower: 'n', upper: 'N' },
        ru: { lower: 'т', upper: 'Т' },
      },
    },
    {
      KeyM: {
        en: { lower: 'm', upper: 'M' },
        ru: { lower: 'ь', upper: 'Ь' },
      },
    },
    {
      Comma: {
        en: { lower: ',', upper: '<' },
        ru: { lower: 'б', upper: 'Б' },
      },
    },
    {
      Period: {
        en: { lower: '.', upper: '>' },
        ru: { lower: 'ю', upper: 'Ю' },
      },
    },
    {
      Slash: {
        en: { lower: '/', upper: '?' },
        ru: { lower: '.', upper: ',' },
      },
    },
    {
      ArrowUp: {
        en: { lower: '&#9650;', upper: '&#9650;' },
        ru: { lower: '&#9650;', upper: '&#9650;' },
      },
    },
    {
      ShiftRight: {
        en: { lower: 'Shift', upper: 'Shift' },
        ru: { lower: 'Shift', upper: 'Shift' },
      },
    },
  ],
  [
    {
      ControlLeft: {
        en: { lower: 'ctrl', upper: 'ctrl' },
        ru: { lower: 'ctrl', upper: 'ctrl' },
      },
    },

    {
      MetaLeft: {
        en: { lower: 'Win', upper: 'Win' },
        ru: { lower: 'Win', upper: 'Win' },
      },
    },
    {
      AltLeft: {
        en: { lower: 'alt', upper: 'alt' },
        ru: { lower: 'alt', upper: 'alt' },
      },
    },
    {
      Space: {
        en: { lower: ' ', upper: ' ' },
        ru: { lower: ' ', upper: ' ' },
      },
    },
    {
      AltRight: {
        en: { lower: 'alt', upper: 'alt' },
        ru: { lower: 'alt', upper: 'alt' },
      },
    },
    {
      ArrowLeft: {
        en: { lower: '&#9668;', upper: '&#9668;' },
        ru: { lower: '&#9668;', upper: '&#9668;' },
      },
    },
    {
      ArrowDown: {
        en: { lower: '&#9660;', upper: '&#9660;' },
        ru: { lower: '&#9660;', upper: '&#9660;' },
      },
    },
    {
      ArrowRight: {
        en: { lower: '&#9658;', upper: '&#9658;' },
        ru: { lower: '&#9658;', upper: '&#9658;' },
      },
    },
    {
      ControlRight: {
        en: { lower: 'ctrl', upper: 'ctrl' },
        ru: { lower: 'ctrl', upper: 'ctrl' },
      },
    },
  ],
];

const CONTROLS = ['Tab', 'CapsLock', 'ShiftLeft', 'ShiftRight', 'ControlLeft', 'MetaLeft', 'AltLeft', 'Space', 'AltRight', 'ControlRight', 'Backspace', 'Enter', 'Delete'];
class Keyboard {
  constructor(content, controls) {
    this.mouseTarget = null;
    this.language = localStorage.getItem('lang') || 'en';
    this.domConfig = content;
    this.isShift = false;
    this.isCapsLock = false;
    this.isAlt = false;
    this.isControl = false;
    this.controls = controls;
    this.printKeyValue = this.printKeyValue.bind(this);
    this.keyCase = 'lower';
    this.cursor = 0;
    this.rows = 0;
  }

  initialDom() {
    let keysLine = '';
    localStorage.setItem('lang', this.language);
    this.domConfig.forEach((line) => {
      let content = '';
      line.forEach((node) => {
        const keyName = Object.keys(node)[0];
        const keyLangs = Object.keys(node[keyName]);
        let keyInner = '';
        keyLangs.forEach((k) => {
          const initialLanguage = this.getLanguage();
          if (initialLanguage === k) {
            keyInner += `<div class="${k} active lower">${node[keyName][k].lower}</div>`;
          } else {
            keyInner += `<div class="${k} lower">${node[keyName][k].lower}</div>`;
          }
          keyInner += `<div class="${k} upper">${node[keyName][k].upper}</div>`;
        });
        content += `<div class="key ${keyName} alphabet">${keyInner}</div>`;
      });
      keysLine += `<div class="keyboard-line">${content}</div>`;
    });
    keysLine = `<div class="wrapper"><div class="container"><div class="keyboard"><div class="keyboard__display"><textarea class="keyboard__textarea" cols="2" wrap="hard"></textarea></div><div class="keyboard__board">${keysLine}</div></div><div class="info"><p>Клавиатура создана в операционной системе Windows</p><p>Для переключения языка комбинация:  ctrl + alt</p></div></div><canvas class="canvas"></canvas></div>`;
    document.body.insertAdjacentHTML('afterbegin', keysLine);
  }

  getLanguage() {
    return localStorage.getItem('lang') || this.language;
  }

  toggleLanguage() {
    let language = localStorage.getItem('lang');
    language = language === 'en' ? 'ru' : 'en';
    this.language = language;
    localStorage.setItem('lang', language);
  }

  keyDown(e) {
    let { keyCode } = e;
    keyCode = Number(keyCode);
    e.preventDefault();
    if (!(keyCode >= 8 && keyCode <= 222)) return;
    const keyPressed = document.querySelector(`.${e.code}`);

    if (!keyPressed) return;
    const keyName = keyPressed.classList[1];

    if ((keyName === 'ShiftLeft' || keyName === 'ShiftRight') && this.isShift) return;
    if ((keyName === 'ShiftLeft' || keyName === 'ShiftRight') && !this.isShift) this.isShift = true;
    if ((keyName === 'AltLeft' || keyName === 'AltRight') && this.isAlt) return;
    if ((keyName === 'AltLeft' || keyName === 'AltRight') && !this.isAlt) this.isAlt = true;
    if ((keyName === 'ControlLeft' || keyName === 'ControlRight') && this.isControl) return;
    if ((keyName === 'ControlLeft' || keyName === 'ControlRight') && !this.isControl) this.isControl = true;
    if ((keyName === 'CapsLock') && this.isCapsLock) return;
    if (['ArrowLeft', 'ArrowUp', 'ArrowRight', 'ArrowDown'].includes(keyName)) {
      keyPressed.classList.add('pressed');
      this.arrowsDown(keyName);
      return;
    }

    if (this.isControl && ((keyName === 'AltLeft' || keyName === 'AltRight'))) {
      this.toggleKeyLanguage();
    }
    if (this.isAlt && (keyName === 'ControlLeft' || keyName === 'ControlRight')) {
      this.toggleKeyLanguage();
    }

    if (keyName === 'ShiftLeft' || keyName === 'ShiftRight') {
      this.toggleKeyCase();
    }

    if (keyName === 'CapsLock') {
      this.isCapsLock = true;
      this.toggleCapsCase();
    }
    this.printKeyValue(keyPressed);
    keyPressed.classList.add('pressed');
  }

  keyUp(e) {
    let { keyCode } = e;
    keyCode = Number(keyCode);
    if (!(keyCode >= 8 && keyCode <= 222)) return;
    e.preventDefault();
    const keyPressed = document.querySelector(`.${e.code}`);

    if (!keyPressed) return;
    const keyName = keyPressed.classList[1];

    if ((keyName === 'ShiftLeft' || keyName === 'ShiftRight')) {
      this.isShift = false;
      this.toggleKeyCase();
    }
    if ((keyName === 'AltLeft' || keyName === 'AltRight')) {
      this.isAlt = false;
    }
    if ((keyName === 'ControlLeft' || keyName === 'ControlRight')) {
      this.isControl = false;
    }
    if (keyName === 'CapsLock') {
      this.isCapsLock = false;
    }
    keyPressed.classList.remove('pressed');
  }

  mouseDown(e) {
    const target = e.target.closest('.key');
    if (!target) return;
    if (target.classList.contains('pressed')) return;
    this.mouseTarget = target;

    target.classList.add('pressed');
    const targetName = target.classList[1];
    if (targetName === 'CapsLock' && !this.isCapsLock) {
      this.toggleCapsCase();
    }
    if (['ArrowLeft', 'ArrowUp', 'ArrowRight', 'ArrowDown'].includes(targetName)) {
      setTimeout(() => { this.arrowsDown(targetName); }, 0);
      return;
    }
    if ((targetName === 'ShiftLeft' || targetName === 'ShiftRight') && !this.isShift) {
      this.isShift = true;
      this.toggleKeyCase();
    }
    if ((targetName === 'ControlLeft' || targetName === 'ControlRight') && !this.isControl) this.isControl = true;
    if ((targetName === 'AltLeft' || targetName === 'AltRight') && !this.isAlt) this.isAlt = true;
    // console.log(this.isControl,this.isAlt)
    if (this.isControl && this.isAlt) {
      this.toggleKeyLanguage();
    }
    setTimeout(() => { this.printKeyValue(target); }, 0);
  }

  mouseUp() {
    const target = this.mouseTarget;
    this.mouseTarget = null;
    if (!target) return;
    const targetName = target.classList[1];
    target.classList.remove('pressed');

    if ((targetName === 'ShiftLeft' || targetName === 'ShiftRight') && this.isShift) {
      this.toggleKeyCase();
      this.isShift = false;
    }
    if ((targetName === 'ControlLeft' || targetName === 'ControlRight') && this.isControl) this.isControl = false;
    if ((targetName === 'AltLeft' || targetName === 'AltRight') && this.isAlt) this.isAlt = false;
  }

  cursorStartPoint(e) {
    const { target } = e;
    if (target.tagName !== 'TEXTAREA') return;
    this.cursor = target.selectionStart;
  }

  renderKeyboard() {
    this.initialDom();
    document.addEventListener('keydown', this.keyDown.bind(this));
    document.addEventListener('keyup', this.keyUp.bind(this));
    document.addEventListener('mousedown', this.mouseDown.bind(this));
    document.addEventListener('mouseup', this.mouseUp.bind(this));
    document.addEventListener('click', this.cursorStartPoint.bind(this));
  }

  printKeyValue(node) {
    const textarea = document.querySelector('.keyboard__textarea');
    const dontPrintControls = ['ShiftLeft', 'CapsLock', 'ControlLeft', 'MetaLeft', 'AltLeft', 'AltRight', 'ControlRight', 'ShiftRight'];
    const textareaValueLength = textarea.value.length;
    const keyName = node.classList[1];
    let cursorValue = 1;
    let keyValue = '';
    if (this.controls.includes(keyName)) {
      if (keyName === 'Space') {
        keyValue = '\xa0';
      }
      if (keyName === 'Tab') {
        keyValue = '\xa0\xa0\xa0\xa0';
        cursorValue = 4;
      }
      if (keyName === 'Enter') {
        keyValue = '\n';
      }
      if (keyName === 'Backspace' && this.cursor >= 0) {
        let textareaValue = textarea.value;
        textareaValue = textareaValue.split('');
        if (!textareaValue[this.cursor - 1]) return;
        textareaValue.splice(this.cursor - 1, 1);
        textarea.value = textareaValue.join('');
        this.cursor -= 1;
        this.textareaSetCursor();
        return;
      }
      if (keyName === 'Delete' && this.cursor >= 0) {
        let textareaValue = textarea.value;
        textareaValue = textareaValue.split('');
        if (!textareaValue[this.cursor]) return;
        textareaValue.splice(this.cursor, 1);
        textarea.value = textareaValue.join('');
        this.textareaSetCursor();
        return;
      }
    } else {
      keyValue = Array.from(node.children).filter((el) => el.classList.contains('active'))[0].innerText;
    }

    if (this.cursor < textareaValueLength) {
      let valueBefor = textarea.value;
      valueBefor = valueBefor.split('');
      valueBefor.splice(this.cursor, 0, keyValue);
      textarea.value = valueBefor.join('');
    } else {
      textarea.value += keyValue;
      this.textareaSetCursor();
    }
    if (!dontPrintControls.includes(keyName)) {
      this.cursor += cursorValue;
      this.textareaSetCursor();
    }
  }

  textareaSetCursor() {
    const textarea = document.querySelector('.keyboard__textarea');
    textarea.selectionEnd = this.cursor;
    textarea.selectionStart = this.cursor;
    textarea.focus();
  }

  arrowsDown(nodeName) {
    if (!nodeName) return;
    const textarea = document.querySelector('.keyboard__textarea');
    const textareaValueLength = textarea.value.length;
    if (nodeName === 'ArrowLeft') {
      if (this.cursor > 0) { this.cursor -= 1; }
    }
    if (nodeName === 'ArrowRight') {
      if (this.cursor < textareaValueLength) { this.cursor += 1; }
    }
    if (nodeName === 'ArrowUp') {
      const rows = textarea.value.split('\n');
      let sumRows = 0;
      let currentRow = 0;
      for (let i = 0; i < rows.length; i += 1) {
        sumRows += rows[i].length;
        if (sumRows >= this.cursor - i) {
          currentRow = i;
          break;
        }
      }
      const offsetRight = textareaValueLength - this.cursor;
      const offsetLeft = sumRows - rows[currentRow].length;
      const sideOffset = textareaValueLength - (offsetRight + offsetLeft + currentRow);
      let mainOffset = 0;
      if (currentRow !== 0) {
        const prevRow = rows[currentRow - 1];

        if (sideOffset < prevRow.length) {
          mainOffset = (prevRow.length - sideOffset) + sideOffset + 1;
        } else { mainOffset = sideOffset + 1; }

        this.cursor -= mainOffset;
      }
    }
    if (nodeName === 'ArrowDown') {
      const rows = textarea.value.split('\n');
      let sumRows = 0;
      let currentRow = 0;
      for (let i = 0; i < rows.length; i += 1) {
        sumRows += rows[i].length;
        if (sumRows >= this.cursor - i) {
          currentRow = i;
          break;
        }
      }
      if (currentRow !== rows.length - 1) {
        const offsetRight = textareaValueLength - this.cursor;
        const offsetLeft = sumRows - rows[currentRow].length;
        const sideOffset = textareaValueLength - (offsetRight + offsetLeft + currentRow);
        const currentRowLength = rows[currentRow].length;
        let mainOffset = 0;
        const nextRow = rows[currentRow + 1];
        if (sideOffset > nextRow.length) {
          mainOffset = (currentRowLength - sideOffset) + nextRow.length + 1;
        } else { mainOffset = sideOffset + 1 + (currentRowLength - sideOffset); }
        this.cursor += mainOffset;
      }
    }
    this.textareaSetCursor();
  }

  toggleKeyCase(node = document) {
    const activeKeys = node.querySelectorAll('.key');
    activeKeys.forEach((key) => {
      Array.from(key.children).forEach((child) => {
        if (child.classList.contains(this.getLanguage())) { child.classList.toggle('active'); }
      });
    });
  }

  toggleCapsCase() {
    document.querySelector('.CapsLock').classList.toggle('on');
    this.toggleCase();
    const rows = document.querySelectorAll('.keyboard-line');
    rows.forEach((row, index) => {
      if (index > 0) this.toggleKeyCase(row);
    });
  }

  toggleKeyLanguage() {
    const activeKeys = document.querySelectorAll('.key');
    activeKeys.forEach((key) => {
      let toggleNode = null;
      Array.from(key.children).forEach((child) => {
        if (child.classList.contains(this.keyCase)
        && !child.classList.contains(this.getLanguage())) {
          toggleNode = child;
        }
        child.classList.remove('active');
      });
      toggleNode.classList.add('active');
    });
    this.toggleLanguage();
  }

  toggleCase() {
    this.keyCase = this.keyCase === 'lower' ? 'upper' : 'lower';
  }

  setShift() {
    this.isShift = !this.isShift;
  }

  getShift() {
    return this.isShift;
  }

  setcursor(p) {
    this.cursor = p;
  }
}
const keyboard = new Keyboard(CONFIG, CONTROLS);
keyboard.renderKeyboard();
